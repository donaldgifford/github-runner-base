name: Test and Lint

on:
  pull_request:
    branches: [main]
    types:
      [
        labeled,
        unlabeled,
        opened,
        edited,
        reopened,
        synchronize,
        ready_for_review,
      ]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: read

jobs:
  lint:
    name: Lint Code
    # runs-on: ubuntu-latest
    runs-on: homelab-runners
    container:
      image: alpine:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.x"
          cache: true

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v9
        continue-on-error: true
        with:
          version: latest
          only-new-issues: true
          args: --timeout=10m --config=.golangci.yml
  test:
    name: Test
    # runs-on: ubuntu-latest
    runs-on: homelab-runners
    container:
      image: alpine:latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.25.x
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: make test

      - name: Get coverage tests
        run: make coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.txt
          fail_ci_if_error: false

  test-all:
    name: Test All
    # runs-on: ubuntu-latest
    runs-on: homelab-runners
    container:
      image: alpine:latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.25.x
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: make test-all
        continue-on-error: true

  build:
    name: Build
    # runs-on: ubuntu-latest
    runs-on: homelab-runners
    container:
      image: alpine:latest
    needs: [test, lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.x"
          cache: true

      - name: Build binary
        run: |
          make build

  security:
    name: Security Scan
    # runs-on: ubuntu-latest
    runs-on: homelab-runners
    container:
      image: golang:latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.x"
          cache: true

      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: "-no-fail -fmt sarif -out gosec-results.sarif ./..."
        continue-on-error: true

  # Test 1: Simple echo test without any actions
  simple-test:
    runs-on: homelab-runners
    container:
      image: ubuntu:latest
    steps:
      - name: Basic Test
        run: |
          echo "Testing ARC runner"
          echo "Runner: $RUNNER_NAME"
          echo "OS: $RUNNER_OS"
          uname -a

  # Test 2: Test with a container that has git pre-installed
  test-with-tools:
    runs-on: homelab-runners
    container:
      image: node:20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show files
        run: |
          ls -la
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"

  # Test 3: Test without container (uses runner's default environment)
  test-no-container:
    runs-on: homelab-runners
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test runner environment
        run: |
          echo "Testing without container"
          which git || echo "Git not found"
          which node || echo "Node not found"
          which docker || echo "Docker not found"
